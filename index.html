<!DOCTYPE html>

<head>
	<style>
		html,
		body,
		div,
		span,
		applet,
		object,
		iframe,
		h1,
		h2,
		h3,
		h4,
		h5,
		h6,
		p,
		blockquote,
		pre,
		a,
		abbr,
		acronym,
		address,
		big,
		cite,
		code,
		del,
		dfn,
		em,
		img,
		ins,
		kbd,
		q,
		s,
		samp,
		small,
		strike,
		strong,
		sub,
		sup,
		tt,
		var,
		b,
		u,
		i,
		center,
		dl,
		dt,
		dd,
		ol,
		ul,
		li,
		fieldset,
		form,
		label,
		legend,
		table,
		caption,
		tbody,
		tfoot,
		thead,
		tr,
		th,
		td,
		article,
		aside,
		canvas,
		details,
		embed,
		figure,
		figcaption,
		footer,
		header,
		hgroup,
		menu,
		nav,
		output,
		ruby,
		section,
		summary,
		time,
		mark,
		audio,
		video {
			margin: 0;
			padding: 0;
			border: 0;
			font-size: 100%;
			font: inherit;
			vertical-align: baseline;
		}

		#slider {
			text-align: center;
			margin: 20px;
			font-family: sans-serif;
			font-size: 10px;
			line-height: 2;
		}

		body {
			height: 100vh;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			background: darkslategrey;
			color: white;
		}

		#sales-range {
			vertical-align: bottom;
		}
	</style>

	<script src="./d3.v5.min.js"></script>

</head>

<body>
	<div>
		<span>all</span>
		<input type='range' id='sales-range' value=0 />
		<span>best sellers</span>
	</div>

	<div id="viz"></div>
	<script>
		// Chart container dimensions
		let svgWidth = 960,
			svgHeight = 500;

		// Chart inner margins / padding
		let margin = {
			top: 30, right: 30, bottom: 150, left: 30
		};

		// Dimensions for the actual chart
		let innerWidth = svgWidth - margin.left - margin.right,
			innerHeight = svgHeight - margin.top - margin.bottom;

		// Position of the chart within the container
		let canvasCenter = {
			x: Math.round((margin.left + margin.right) / 2),
			y: Math.round((margin.top + margin.bottom) / 2)
		};

		// Main SVG element containing all others
		let svg = d3.select('#viz')
			.append('svg')
			.attr('width', svgWidth)
			.attr('height', svgHeight)
			.append('g')
			.attr('transform', `translate(${margin.left}, ${margin.top})`);

		// Scale ranges
		let xScale = d3.scaleBand()
			.range([0, innerWidth])
			.padding(0.1);
		let yScale = d3.scaleLinear()
			.range([innerHeight, 0]);

		// Data fetching
		d3.csv('sales.csv', d => {
			d.sales = +d.sales;
			return d;
		})
			.then(results => {
				setDomains(results);
				createAxis();
				createBars(results);

				let rangeSlider = document.getElementById('sales-range');
				rangeSlider.min = 0;
				rangeSlider.max = d3.max(results, d => d.sales);
				rangeSlider.onchange = () => {
					let filteredData = results.filter(d => d.sales >= rangeSlider.value);
						createBars(filteredData);
				}
			})
			.catch(e => {
				throw e;
			});

		function setDomains(results) {
			let maxVal = d3.max(results, d => d.sales);
			xScale.domain(results.map(d => d.flavors));
			yScale.domain([0, maxVal]).nice();
		}

		function createAxis() {
			svg.append('g')
				.call(d3.axisLeft(yScale))
				.selectAll('text')
				.style('fill', 'white');

			svg.append('g')
				.attr('transform', `translate(0,${innerHeight})`)
				.call(d3.axisBottom(xScale))
				.selectAll('text')
				.attr('x', xScale.bandwidth() / 2)
				.attr('y', 0)
				.attr('dy', '.35em')
				.attr('transform', 'rotate(90)')
				.attr('text-anchor', 'start')
				.style('fill', 'white')
		}

		function createBars(results) {
			svg.selectAll('.bar-group')
				.data(results, d => d.flavors)
				.join(
					enter => {
						let bar = enter.append('g')
							.attr('class', 'bar-group')
							.style('opacity', 1);

						bar.append('rect')
							.attr('class', 'bar')
							.attr('x', d => xScale(d.flavors))
							.attr('y', d => yScale(0))
							.attr('width', xScale.bandwidth())
							.attr('height', 0)
							.style('fill', 'darkkhaki')
							.transition().duration(750)
							.attr('y', d => yScale(d.sales))
							.attr('width', xScale.bandwidth())
							.attr('height', d => innerHeight - yScale(d.sales))

						bar.append('text')
							.text(d => d.sales)
							.attr('x', d => xScale(d.flavors) + (xScale.bandwidth() / 2))
							.attr('y', d => yScale(d.sales) - 5)
							.attr('text-anchor', 'middle')
							.style('font-family', 'sans-serif')
							.style('font-style', 'italic')
							.style('font-size', '10')
							.attr('fill', 'gray')
							.style('opacity', 0)
							.transition().duration(500)
							.style('opacity', 1);
					},
					update => { 
						update.transition().duration(750).style('opacity', 1);
					},
					exit => {
						exit.transition().duration(750).style('opacity', 0.15);
					}
				)

		}
	</script>
</body>

</html>